---
import { user } from '../libs/stores';
import { validSession } from '../libs/session';
import { profileUpdateForm, uploadPhotoForm, deployForm } from '../libs/forms';

import Layout from '../layouts/Logged.astro';
import FAB from '@components/FAB.astro';
import CommonButton from '@components/CommonButton.astro';
import Dialog from '@components/Dialog.astro';

let error;
const session = Astro.cookies.get('session')?.value;
const sessionValid = await validSession(session);

if (!sessionValid) {
	Astro.cookies.delete('session');
	return Astro.redirect('/login');
}

const action = Astro.url.searchParams.get('action');

if (Astro.request.method === 'POST') {
	if (!sessionValid) return 'Invalid session.';

	const formData = await Astro.request.formData();

	switch (action) {
		case 'profile-update':
			profileUpdateForm(formData);
			break;
		case 'upload-photo':
			uploadPhotoForm(formData);
			break;
		case 'deploy':
			deployForm();
			break;
		default:
			break;
	}
}
---

{action === 'upload-photo' && <Dialog href="config">1</Dialog>}
{
	action === 'deploy' && (
		<Dialog href="config">
			<div class="card">
				<h1>Update your Snapi?</h1>
				<p>Any changes you have done onyour profile or gallery will be available online.</p>
				<form method="post" action="?action=deploy">
					<CommonButton primary>Deploy</CommonButton>
				</form>
			</div>
		</Dialog>
	)
}

<Layout title="Configuration">
	<FAB href="?action=upload-photo" icon="tabler:photo-plus" />
</Layout>

<style>
	h1 {
		font: var(--title-large);
	}

	.centered-container {
		align-items: center;
		display: flex;
		height: 100%;
		justify-content: center;
		width: 100%;
	}

	.card {
		background: #171717;
		border-radius: 12px;
		display: flex;
		flex-direction: column;
		gap: 16px;
		max-width: 480px;
		padding: 24px;
		width: 100%;
	}
</style>
