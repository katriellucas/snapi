---
export const prerender = false;
import { user } from '../libs/stores';
import TextField from '@components/TextField.astro';
import Fullscreen from '../layouts/Fullscreen.astro';
import FAB from '@components/FAB.astro';
import CommonButton from '@components/CommonButton.astro';

let logged = false;

if (Astro.request.method === 'POST') {
	const formData = await Astro.request.formData();

	if (logged === false) {
		const password = formData.get('password') as string;
		if (password === import.meta.env.PASSWORD) {
			const uuid = crypto.randomUUID();
			user.set('session', uuid);
			Astro.cookies.set('session', uuid);
		}
	} else {
		Astro.cookies.delete('session');
	}
}

if (Astro.cookies.has('session')) {
	const session = Astro.cookies.get('session');
	session?.value === (await user.get('session'))
		? (logged = true)
		: Astro.cookies.delete('session');
}

let profile;

if (logged === true) {
	profile = await user.get('profile');
}
---

{
	logged ? (
		<Fullscreen title="Welcome to Astro.">
			<form method="post">
				<div class="card">
					<TextField label="Username" name="username" value={profile?.username ?? 'John Doe'} />
					<TextField label="Job" name="job" value={profile?.job ?? 'Photographer'} />
					<TextField
						label="description"
						name="description"
						value={profile?.description ?? 'Photographer'}
					/>
				</div>
				<div class="card">
					<h2>Call to action</h2>
					<TextField
						label="Button label"
						name="action-button-label"
						value={profile?.action_button_label ?? 'Call to action'}
					/>
					<TextField
						label="Button link"
						name="action-button-link"
						value={profile?.action_button_link ?? 'Photographer'}
					/>
					<CommonButton>Save</CommonButton>
				</div>
			</form>
			<FAB href="/upload" icon="tabler:photo-plus" />
		</Fullscreen>
	) : (
		<Fullscreen title="Welcome to Astro.">
			<section class="centered-container">
				<form class="card" method="post">
					<h1>Settings</h1>
					<TextField label="Password" name="password" required />
					<button>Submit</button>
				</form>
			</section>
		</Fullscreen>
	)
}

<style>
	h1 {
		font: var(--title-large);
		margin-bottom: 16px;
	}
	.centered-container {
		align-items: center;
		display: flex;
		height: 100%;
		justify-content: center;
		width: 100%;
	}

	.card {
		background: #171717;
		border-radius: 12px;
		max-width: 480px;
		padding: 16px;
		width: 100%;
	}
</style>
